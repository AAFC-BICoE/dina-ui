version: "3.6"
services:
  database:
    image: postgres:9.6
    environment:
      POSTGRES_DB: seqdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: p
    volumes:
      - ./seqdb-initdb.sql:/docker-entrypoint-initdb.d/1-seqdb-initdb.sql
  api:
    image: maven:3.6.3-jdk-8
    volumes:
      - "../repos/seqdb-api:/app"
      # Use the host maven repository:
      - "$HOME/.m2:/root/.m2"
    ports:
      - "8080:8080" # app port
      - "5005:5005" # debug port
    # The maven container ignores the docker-compose "environment" field, so pass in variables in the command:
    command: >
      bash -c "
      mvn
      -f /app/pom.xml
      -Dspring-boot-maven-plugin.fork=true
      -Dspring-boot.run.jvmArguments=\"
        -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005
        -Dspring.datasource.url=jdbc:postgresql://database/seqdb?currentSchema=seqdb
        -Dspring.datasource.username=postgres
        -Dspring.datasource.password=p
        -Dspring.liquibase.user=postgres
        -Dspring.liquibase.password=p
        -Dspring.datasource.continue-on-error=true
        -Dspring.servlet.multipart.max-file-size=2GB
        -Dspring.servlet.multipart.max-request-size=2GB
        -Dimport-sample-accounts=true
      \"
      spring-boot:run
      "
  # Server that hot-reloads the UI source code:
  ui-dev-server:
    image: node:12.16.1
    volumes:
      - "../repos/dina-ui:/dina-ui"
    stop_signal: SIGINT
    command: >
      bash -c "
      yarn --cwd=/dina-ui/packages/seqdb-ui ;
      yarn --cwd=/dina-ui/packages/seqdb-ui next
      "
  # Front-end gateway that proxies URLs to the correct service:
  ui:
    image: abiosoft/caddy:1.0.3-no-stats
    volumes:
      - "./ui.Caddyfile:/etc/Caddyfile"
    environment:
      UI_DEV_SERVER_ADDRESS: ui-dev-server:3000
      API_ADDRESS: api:8080
    ports:
      - "2015:2015"
